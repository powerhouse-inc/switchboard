events {}

http {
    log_format proxy_log '[$time_local] Proxy: "$proxy_host" "$upstream_addr" '
                    '$remote_addr - $remote_user "$host$request_uri" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    server {
        # frontend
        location / {
            proxy_pass http://frontend:3000;
        }

        # api
        location /backend/ {
            rewrite /backend/(.*) /$1 break;
            proxy_pass http://api:3000;
            proxy_set_header Host $host;
        }

        # graphql API composition
        location /wundergraph/graphql {
            rewrite /wundergraph/graphql /graphql break;
            proxy_pass http://wundergraph:3002;
            proxy_set_header Host $host;
        }
    }
}
